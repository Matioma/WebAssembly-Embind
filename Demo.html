<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.7.0/dist/css/uikit.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.7.0/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.7.0/dist/js/uikit-icons.min.js"></script>
</head>

<body>
    <div class="uk-flex .uk-flex-center">
        <section id="canvasContainer">
        </section>
        <div class="uk-container">
            <div class="js-upload fragment-upload uk-placeholder uk-text-center">
                <span uk-icon="icon: cloud-upload"></span>
                <span class="uk-text-middle">Load Vertex Shader by dropping them here or</span>
                <div uk-form-custom>
                    <input id="vertex-shader" type="file" multiple (click)="">
                    <span class="uk-link">selecting one</span>
                </div>
            </div>
            <div class="js-upload uk-placeholder uk-text-center">
                <span uk-icon="icon: cloud-upload"></span>
                <span class="uk-text-middle">Load Fragment Shader by dropping them here or</span>
                <div uk-form-custom>
                    <input id="fragment-shader" type="file" multiple>
                    <span class="uk-link">selecting one</span>
                </div>
            </div>

            <!-- <progress id="js-progressbar" class="uk-progress" value="0" max="100" hidden></progress> -->
            <button id="RenderBtn" class="uk-button uk-button-primary">Render</button>
        </div>
    </div>
</body>

<script src="./JavaScriptAlternative/Vector3.js"></script>
<script src="./Utility/ExecutionTime.js"></script>

<script>
    var Module = {
        onRuntimeInitialized: function () {
            let Renderer = new Module["Renderer"]();

            const createCanvas = (id, index, width, height) => {
                const canvas = document.createElement("canvas")
                canvas.id = id
                canvas.width = width
                canvas.height = height
                canvasContainer.appendChild(canvas)
                const context = canvas.getContext("webgl2")
                Renderer.CreateContext(width, height, id, index)
            };
            createCanvas("FirstCanvas", 0, 300, 300);

            // Renderer.Run();


            document.getElementById("RenderBtn").addEventListener("click", () => {
                // console.log(fragmentSource);
                Renderer.LoadMaterial(vertexSource, fragmentSource);
                Renderer.Run();
            });
        }
    };
    const readUploadedFileAsText = (inputFile) => {
        const temporaryFileReader = new FileReader();

        return new Promise((resolve, reject) => {
            temporaryFileReader.onerror = () => {
                temporaryFileReader.abort();
                reject(new DOMException("Problem parsing input file."));
            };

            temporaryFileReader.onload = () => {
                resolve(temporaryFileReader.result);
            };
            temporaryFileReader.readAsText(inputFile);
        });
    };

    const handleUpload = async (event) => {
        const file = event.target.files[0];
        try {
            const fileContents = await readUploadedFileAsText(file);
            return fileContents;
        } catch (e) {
            console.warn(e.message)
        }
    }

    let fragmentSource;
    let vertexSource;


    function clearInput(target) {
        target.value = null;
    }


    let vertexInput = document.getElementById("vertex-shader");
    vertexInput.addEventListener("click", (ev) => clearInput(ev.target));
    vertexInput.addEventListener("input", (ev) => {
        handleUpload(ev).then(res => {
            vertexSource = res;

        });
    });

    let fragmentInput = document.getElementById("fragment-shader");
    fragmentInput.addEventListener("click", (ev) => clearInput(ev.target));
    fragmentInput.addEventListener("input", (ev) => {
        handleUpload(ev).then(res => {
            fragmentSource = res;
        });
    });




    // var bar = document.getElementById('js-progressbar');

    // UIkit.uploadDrop('.fragment-upload', {
    //     url: '',
    //     multiple: true,

    //     beforeSend: function () {
    //         console.log('beforeSend', arguments);
    //     },
    //     beforeAll: function () {
    //         console.log('beforeAll', arguments);
    //     },
    //     load: function () {
    //         console.log('load', arguments);
    //     },
    //     error: function () {
    //         console.log('error', arguments);
    //     },
    //     complete: function () {
    //         console.log('complete', arguments);
    //     },

    //     loadStart: function (e) {
    //         console.log('loadStart', arguments);

    //         bar.removeAttribute('hidden');
    //         bar.max = e.total;
    //         bar.value = e.loaded;
    //     },

    //     progress: function (e) {
    //         console.log('progress', arguments);

    //         bar.max = e.total;
    //         bar.value = e.loaded;
    //     },

    //     loadEnd: function (e) {
    //         console.log('loadEnd', arguments);

    //         bar.max = e.total;
    //         bar.value = e.loaded;
    //         console.log(e.target);

    //         displayShader(document.getElementById("vertex-shader"));
    //     },

    //     completeAll: function () {
    //         console.log('completeAll', arguments);

    //         setTimeout(function () {
    //             bar.setAttribute('hidden', 'hidden');
    //         }, 1000);

    //         alert('Upload Completed');
    //     }

    // });


    // let values = [];
    // const vectorsCount = 10000;
    // const maxValue = 9999;

    // function generateVectorValues(amount, maxValue) {
    //     for (let i = 0; i < amount * 3; i++) {
    //         values.push(Math.floor(Math.random() * maxValue));
    //     }
    // }
    // generateVectorValues(vectorsCount, maxValue);
    // console.log(values);




    // // function toArray(vector) {
    // //     let array = [];
    // //     for (let i = 0; i < vector.size(); i++) {
    // //         array.push(vector.get(i));
    // //     }
    // //     return array;
    // // }

    // function getVector(arr) {
    //     var vec = new Module.VectorFloat();
    //     for (var i = 0; i < arr.length; i++) {
    //         vec.push_back(arr[i]);
    //     }
    //     return vec;
    // }
    // var Module = {
    //     onRuntimeInitialized: function () {
    //         var arr1 = new Float32Array(values);
    //         let performance = new Module["PerformanceTest"](getVector(arr1));

    //         console.log("Big Function WASm");
    //         ExecutionTime.TestTime(() => {

    //             performance.SumVectors();
    //         })
    //         // let vector = new Module["Vector3"](3, 4, 12);

    //         // var arr1 = new Float32Array([1, 2, 3, 4, 1, 1, 2, 3, 2, 1, 1, 4, 1, 2, 3, 1]);
    //         // var arr2 = new Float32Array([5, 2, 3, 4, 1, 3, 2, 3, 2, 1, 1, 4, 1, 2, 15, 1]);

    //         // let matrix4 = new Module["Matrix4"](getVector(arr1));
    //         // let matrix1 = new Module["Matrix4"](getVector(arr2));
    //         // let matrix2 = Module.Matrix4.Identity();
    //         // let result = matrix4.MultiplyMatrix(matrix2);

    //         // let mat4Xmat1 = matrix4.MultiplyMatrix(matrix1);
    //         // let scaled = matrix4.MultiplyValue(6.0);

    //         // console.log(toArray(matrix4.values));
    //         // console.log(toArray(matrix1.values));
    //         // console.log(toArray(mat4Xmat1.values));
    //         // console.log(toArray(scaled.values));

    //         console.log("Wasm From Js");
    //         ExecutionTime.TestTime(() => {

    //             for (let i = 0; i < values.length - 3; i += 3) {
    //                 let vec2 = new Module["Vector3"](values[i], values[i + 1], values[i + 2]);
    //                 let vec3 = new Module["Vector3"](values[i + 3], values[i + 4], values[i + 5]);
    //                 let magnitude = vec2.Subtract(vec3).Magnitude() > 5;
    //             }
    //         })
    //     }
    // };


    // console.log("Pure Js");
    // ExecutionTime.TestTime(() => {

    //     for (let i = 0; i < values.length - 3; i += 3) {
    //         let vec2 = new Vector3(values[i], values[i + 1], values[i + 2]);
    //         let vec3 = new Vector3(values[i + 3], values[i + 4], values[i + 5]);

    //         let magnitude = vec2.Subtract(vec3).Magnitude() > 5;
    //     }
    // })
</script>
<!-- <script src="./Math/Math.js"></script> -->

<script src="./Engine/dist/demo.js"></script>

</html>