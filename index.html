<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.7.0/dist/css/uikit.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.7.0/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.7.0/dist/js/uikit-icons.min.js"></script>
</head>

<body>
    <div class="uk-container uk-margin-top">
        <!-- This is a button toggling the modal -->
        <button class="uk-button uk-button-primary uk-margin-small-right" type="button"
            uk-toggle="target: #modal-example">Explanation</button>

        <!-- This is the modal -->
        <div id="modal-example" uk-modal>
            <div class="uk-modal-dialog uk-modal-body">
                <h2 class="uk-modal-title">App Explanation</h2>
                <p>This is web app Allows to visualize 3d objects in .obj format and to use custom
                    simple shaders to modify the output, you can rotate the shape or scale it too. As an example, we can
                    use the following files, after selecting all 3 files just click the button <span
                        class="uk-label uk-label-primary">Render</span>:
                </p>

                <div class="uk-section uk-section-primary uk-light">
                    <div class="uk-container">
                        <ul class="uk-list">

                            <li class="uk-flex uk-flex-between">
                                <label class="uk-width-1-3">Vertex</label>
                                <a
                                    href="https://matioma.github.io/WebAssembly-Embind/ExampleFiles/vertexShader.vs">https://matioma.github.io/WebAssembly-Embind/ExampleFiles/vertexShader.vs</a>
                            </li>
                            <li class="uk-flex">
                                <label class="uk-width-1-3">Fragment</label>
                                <a href="https://matioma.github.io/WebAssembly-Embind/ExampleFiles/fragmentShader.fs">
                                    https://matioma.github.io/WebAssembly-Embind/ExampleFiles/fragmentShader.fs</a>
                            </li>
                            <li class="uk-flex">
                                <label class="uk-width-1-3">Obj</label>
                                <a href="https://matioma.github.io/WebAssembly-Embind/ExampleFiles/cylinder_flat.obj">
                                    https://matioma.github.io/WebAssembly-Embind/ExampleFiles/cylinder_flat.obj</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="uk-section uk-section-secondary uk-light">
                    <div class="uk-container">

                        <h3>Attention</h3>
                        <div>
                            <p>You are not obliged to download the files. You can just copy/paste the links when you try
                                to load the files in the forms</p>
                        </div>
                    </div>
                </div>

                <p class="uk-text-right">
                    <button class="uk-button uk-button-default uk-modal-close" type="button">Close</button>
                </p>
            </div>

        </div>
    </div>

    </div>
    <div class="uk-flex .uk-flex-center uk-container uk-margin-top">
        <section id="canvasContainer">
        </section>
        <div class="uk-container">
            <div class="js-upload fragment-upload uk-placeholder uk-text-center">
                <span uk-icon="icon: cloud-upload"></span>
                <span class="uk-text-middle">Load Vertex Shader by dropping them here or</span>
                <div uk-form-custom>
                    <input id="vertex-shader" type="file" multiple (click)="">
                    <span class="uk-link">selecting one</span>
                </div>
            </div>
            <div class="js-upload uk-placeholder uk-text-center">
                <span uk-icon="icon: cloud-upload"></span>
                <span class="uk-text-middle">Load Fragment Shader by dropping them here or</span>
                <div uk-form-custom>
                    <input id="fragment-shader" type="file" multiple>
                    <span class="uk-link">selecting one</span>
                </div>
            </div>
            <div class="js-upload uk-placeholder uk-text-center">
                <span uk-icon="icon: cloud-upload"></span>
                <span class="uk-text-middle">Load Obj File by dropping them here or</span>
                <div uk-form-custom>
                    <input id="obj-file" type="file" multiple>
                    <span class="uk-link">selecting one</span>
                </div>
            </div>

            <!-- <progress id="js-progressbar" class="uk-progress" value="0" max="100" hidden></progress> -->
            <div class="uk-button-group">
                <button id="RenderBtn" class="uk-button uk-button-primary">Render</button>
            </div>


            <div class="uk-container-expand uk-margin-top">
                <div class="uk-container">
                    <label>Scale</label>
                    <form name="scaleF" class="uk-grid-small uk-form-stacked" uk-grid>
                        <div>
                            <div class="uk-inline">
                                <span class="uk-form-icon"> X:</span>
                                <input id="fScaleX" class="uk-input" type="number" placeholder="1" value=1>
                            </div>
                        </div>
                        <div>
                            <div class="uk-inline">
                                <span class="uk-form-icon"> Y:</span>
                                <input id="fScaleY" class="uk-input" type="number" placeholder="1" value=1>
                            </div>
                        </div>
                        <div>
                            <div class="uk-inline">
                                <span class="uk-form-icon"> Z:</span>
                                <input id="fScaleZ" class="uk-input" type="number" placeholder="1" value=1>
                            </div>
                        </div>
                    </form>
                </div>
                <hr class="uk-divider-icon">


                <label>Rotation Speed</label>
                <form name="rotationSpeed" class="uk-grid-small uk-form-stacked" uk-grid>
                    <div>
                        <div class="uk-inline">
                            <span class="uk-form-icon"> X:</span>
                            <input id="fRotSpeedX" class="uk-input" type="number" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <div class="uk-inline">
                            <span class="uk-form-icon"> Y:</span>
                            <input id="fRotSpeedY" class="uk-input" type="number" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <div class="uk-inline">
                            <span class="uk-form-icon"> Z:</span>
                            <input id="fRotSpeedZ" class="uk-input" type="number" placeholder="0">
                        </div>
                    </div>
                </form>
                <!-- <button id="UpdateModelBtn" class="uk-button uk-button-primary">Update values</button> -->
            </div>

        </div>
    </div>
</body>

<script src="./JavaScriptAlternative/Vector3.js"></script>
<script src="./Utility/ExecutionTime.js"></script>

<script>
    let Renderer;
    var Module = {
        onRuntimeInitialized: function () {
            Renderer = new Module["RendererAPI"]();

            const createCanvas = (id, index, width, height) => {
                const canvas = document.createElement("canvas")
                canvas.id = id
                canvas.width = width
                canvas.height = height
                canvasContainer.appendChild(canvas)
                const context = canvas.getContext("webgl2")
                Renderer.CreateContext(width, height, id, index)
            };
            createCanvas("FirstCanvas", 0, 300, 300);
        }
    };


    let lastTime = (new Date()).getTime();
    let currentTime = 0;
    let deltaTime = 0;

    function Update() {
        if (isRunning) {

            Renderer.Update(deltaTime / 1000.0);

        }
        currentTime = (new Date()).getTime();
        deltaTime = currentTime - lastTime;
        lastTime = currentTime;
        requestAnimationFrame(Update);
    }

    let isRunning = false;

    function startRenderer() {
        isRunning = true;
        requestAnimationFrame(Update);
    }

    function stopRenderer() {
        isRunning = false;
    }




    document.getElementById("RenderBtn").addEventListener("click", () => {
        stopRenderer()
        Renderer.LoadMeshData(objFile);
        Renderer.LoadMaterial(vertexSource, fragmentSource);
        startRenderer();
    })


    let scaleX = 1;
    let scaleY = 1;
    let scaleZ = 1;

    document.getElementById("fScaleX").addEventListener("input", (e) => {
        scaleX = parseFloat(e.target.value);
        Renderer.SetScale(scaleX, scaleY, scaleZ);
    })
    document.getElementById("fScaleY").addEventListener("input", (e) => {
        scaleY = parseFloat(e.target.value);
        Renderer.SetScale(scaleX, scaleY, scaleZ);
    })
    document.getElementById("fScaleZ").addEventListener("input", (e) => {
        scaleZ = parseFloat(e.target.value);
        Renderer.SetScale(scaleX, scaleY, scaleZ);
    })



    let rotationSpeedX = 0;
    let rotationSpeedY = 0;
    let rotationSpeedZ = 0;

    document.getElementById("fRotSpeedX").addEventListener("input", (e) => {
        rotationSpeedX = parseFloat(e.target.value);
        if (isNaN(rotationSpeedX)) return;
        Renderer.SetRotationSpeed(rotationSpeedX, rotationSpeedY, rotationSpeedZ);
    })
    document.getElementById("fRotSpeedY").addEventListener("input", (e) => {
        rotationSpeedY = parseFloat(e.target.value);
        if (isNaN(rotationSpeedY)) return;
        Renderer.SetRotationSpeed(rotationSpeedX, rotationSpeedY, rotationSpeedZ);
    })
    document.getElementById("fRotSpeedZ").addEventListener("input", (e) => {
        rotationSpeedZ = parseFloat(e.target.value);
        if (isNaN(rotationSpeedZ)) return;
        Renderer.SetRotationSpeed(rotationSpeedX, rotationSpeedY, rotationSpeedZ);
    })

    // function updateModel() {

    //     // Renderer.SetScale(scaleX, scaleY, scaleZ);
    // }
    // document.getElementById("UpdateModelBtn").addEventListener("click", () => {
    //     updateModel();
    // })
</script>
<script src="FileFunctions.js"></script>

<script>
</script>


<script>
    //Variable regarding shaders
    let fragmentSource;
    let vertexSource;
    let objFile;

    function clearInput(target) {
        target.value = null;
    }

    //Subscribe to input events
    let vertexInput = document.getElementById("vertex-shader");
    vertexInput.addEventListener("click", (ev) => clearInput(ev.target));
    vertexInput.addEventListener("input", (ev) => {
        handleUpload(ev).then(res => {
            vertexSource = res;
        });
    });

    let fragmentInput = document.getElementById("fragment-shader");
    fragmentInput.addEventListener("click", (ev) => clearInput(ev.target));
    fragmentInput.addEventListener("input", (ev) => {
        handleUpload(ev).then(res => {
            fragmentSource = res;
        });
    });

    let objFileId = document.getElementById("obj-file");
    objFileId.addEventListener("click", (ev) => clearInput(ev.target));
    objFileId.addEventListener("input", (ev) => {
        handleUpload(ev).then(res => {
            objFile = res;
        });
    });
</script>


<script src="./Engine/dist/Renderer.js"></script>

</html>